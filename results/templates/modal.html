{% from "loader-macros.html" import lazy_loader %}

{% macro collapse_header(text, text_size=4, collapsed=False) %}
    <div class="collapse-header level is-mobile {% if collapsed %}collapsed{% endif %}" onclick="toggle_slider($(this))">
        <div class="level-left">
            <h3 class="title is-{{ text_size }}">{{ text }}</h3>
        </div>
        <div class="level-right">
            <span class="icon">
                {% if collapse %}
                <i class="fas fa-angle-down is-size-{{ text_size }}"></i>
                {% else %}
                <i class="fas fa-angle-up is-size-{{ text_size }}"></i>
                {% endif %}
            </span>
        </div>
    </div>
{% endmacro %}

{% macro print_pickset_table(players, PGA_PHOTO_URL) %}
    {% if players|length == 0 %}<h6>No players competing</h6>
    {% else %}
    <table class="table is-fullwidth is-hoverable">
        <thead><tr><th>&nbsp;</th><th>Name</th><th class="has-text-centered">Position</th><th class="has-text-centered">Points</th></tr></thead>
        <tbody>
        {% for player in players|sort(attribute="points", reverse=True) %}
            <tr class="pick-row" data-pid="{{ player.id }}">
                <td>{{ lazy_loader(PGA_PHOTO_URL % player.id, loader="ripple", size="64x64") }}</td>
                <td onclick="prompt_modal($(this).parent().data('pid'), $(this).text(), false, undefined)" style="cursor: pointer">
                    {{ player.name }}
                </td>
                <td class="has-text-centered">{% if player.pos is not none %}{{ player.pos }}{% else %}-{% endif %}</td>
                <td class="has-text-centered">{{ player.points }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}
{% endmacro %}


{% macro pickset_modal(pickset=[], PGA_PHOTO_URL="") %}
    <div class="tabs is-centered">
        <ul>
            <li onclick="modal_switch_tabs($(this), '#current-tournament-section')" class="is-active"><a>Current Tournament</a></li>
            <li onclick="modal_switch_tabs($(this), '#tournament-history-section')"><a>Tournament History</a></li>
        </ul>
    </div>
    <section class="tab-section" id="current-tournament-section">
        <div style="text-align:right;margin: 10px">
            <label style="cursor: pointer">
                Organize
                <input type="checkbox" onchange="organize_table($(this))">
            </label>
        </div>

        <table class="table is-fullwidth is-hoverable">
            <thead><tr><th>&nbsp;</th><th>Name</th><th class="has-text-centered">Position</th><th class="has-text-centered">Points</th></tr></thead>
            <tbody>
            {% for player in pickset.picks|sort(attribute="points", reverse=True) %}
                <tr onclick="prompt_modal($(this).data('pid'), $(this).find('.td-player-name').text(), false, undefined)" style="cursor: pointer" class="pick-row" data-pid="{{ player.id }}" data-level="{{ player.level }}">
                    <td>{{ lazy_loader(PGA_PHOTO_URL % player.id, loader="ripple", size="64x64") }}</td>
                    <td class="td-player-name">
                        {{ player.name }}
                    </td>
                    <td class="has-text-centered">{% if player.pos is not none %}{{ player.pos }}{% else %}-{% endif %}</td>
                    <td class="td-points has-text-centered">{{ player.points }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </section>
    <section class="tab-section" id="tournament-history-section">
        <table class="table is-fullwidth">
            <tr><th>Tournament</th><th class="has-text-centered">Position</th><th class="has-text-centered">Points</th></tr>
            {% for result in pickset.tournament_history %}
            <tr>
                <td>{{ result.name }}</td>
                <td class="has-text-centered">{{ result.pos }}</td>
                <td class="has-text-centered">{{ result.points }}</td>
            </tr>
            {% endfor %}
        </table>
    </section>
    <script>
    function modal_switch_tabs(e, section) {
        $('#standings-modal').find(".tabs li").removeClass("is-active");
        e.addClass('is-active');
        $(".tab-section").hide();
        $(section).show();
    }
    var unorganized_html = $("#current-tournament-section").find("tbody").html();
    function organize_table(checkbox) {
        let section = $("#current-tournament-section");
        const rows = section.find(".pick-row").detach();

        let tbody = section.find("tbody").empty();

        if(checkbox.prop("checked")) {
            let table_sections = [[],[],[],[],[]];
            rows.each(function() {
                const row = $(this);
                table_sections[parseInt(row.data("level"))].push(row);
                if(parseInt(row.find(".td-points").text()) > 0) {
                    table_sections[0].push(row[0].outerHTML)
                }
            });
            for(let i = 0; i < 5; i++) {
                if(i === 0)
                    tbody.append("<tr><td class='has-text-centered' style='text-decoration:underline' colspan='4'>Scoring Points</td></tr>");
                else
                    tbody.append("<tr><td class='has-text-centered' style='text-decoration:underline' colspan='4'>Level " + i.toString() + "</td></tr>");

                if(table_sections[i].length > 0)
                    tbody.append(table_sections[i]);
                else
                    tbody.append("<tr><td class='has-text-centered' colspan='4'>No players to show</td></tr>");
            }
        }
        else {
            tbody.html(unorganized_html);
        }
    }
    </script>
{% endmacro %}


{% macro player_modal(player_data, year, PGA_PHOTO_URL) %}
<div class="media">
    {{ lazy_loader(PGA_PHOTO_URL % player_data.id, size="custom", loader="ripple", media_left=True) }}
    <div class="media-content">
        <table class="table is-fullwidth is-striped stats-table">
            <tr class="hide"></tr>
            <tr><th>Position</th><th>Score</th></tr>
            <tr>
                <td>{% if player_data.pos is none %}-{% else %}{{ player_data.pos }}{% endif %}</td>
                <td>
                    {% if player_data.total < 0 %}{{ player_data.total }}
                    {% elif player_data.total > 0 %}+{{ player_data.total }}
                    {% else %}E{% endif %}
                </td>
            </tr>
            <tr><th>Thru</th><th>Points</th></tr>
            <tr>
                <td>
                    {% if player_data.thru is none %}-
                    {% elif player_data.thru == 18 %}F
                    {% else %}{{ player_data.thru }}
                    {% endif %}
                </td>
                <td>{% if player_data.points is none %}0{% else %}{{ player_data.points }}{% endif %}</td>
            </tr>
        </table>
    </div>
</div>
<hr>
<section class="who-picked-section">
    {% if player_data.num_picked == 0 %}
        <h2 class="title is-5">Player was not picked</h2>
    {% else %}

    {{ collapse_header("Picked by " + player_data.num_picked|string + " Person(s)", collapsed=player_data.num_picked > 5, text_size=5) }}
    <div class="collapse-wrapper">
        <table id="picked-by-table" class="table is-fullwidth">
            {% for ps in player_data.picked_by.picksets %}
            <tr><td>{{ ps.name }}</td></tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}
    <hr>
</section>
<section>
    {% if player_data.tournament_history|length > 0 %}
        <h2 class="title is-5">Tournament Scoring History {{ year }}</h2>
        <table class="table is-fullwidth">
            <tr><th>Tournament</th><th class="has-text-centered">Position</th><th class="has-text-centered">Points</th></tr>
            {% for result in player_data.tournament_history %}
            <tr>
                <td>{{ result.name }}</td>
                <td class="has-text-centered">{% if result.pos is none %}-{% else %}{{ result.pos }}{% endif %}</td>
                <td class="has-text-centered">{{ result.points }}</td>
            </tr>
            {% endfor %}
        </table>
    {% else %}
        <h2 class="title is-5">Player has no {{ year }} tournament scoring history</h2>
    {% endif %}
    <hr>
</section>
{% endmacro %}